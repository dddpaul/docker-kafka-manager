ext {
  imagePrefix = project.properties['imagePrefix'] ?: "docker.moscow.alfaintra.net"
  imageName = project.properties['imageName'] ?: "kafka-manager"
}

allprojects {
  configurations {
    provided
  }
}

task build() << {
  logger.quiet "build project $project.name"
  def command = "docker build -t $imagePrefix/$imageName:${getVersionName()} $project.projectDir.absolutePath"
  shellDo(command)
}

def shellDo(command) {
  logger.quiet command
  def proc = command.execute();
  proc.waitForProcessOutput(System.out, System.err)
}

task push() << {
  logger.quiet "push project $project.name"
  def command = "docker push $imagePrefix/$imageName:${getVersionName()}"
  shellDo(command)
}

def getVersionName() {
  def stdout = new ByteArrayOutputStream()
  exec {
    commandLine 'git', 'describe', '--tags'
    standardOutput = stdout
  }
  return stdout.toString().trim()
}

task wrapper(type: Wrapper) {
  gradleVersion = '2.14'
}
